#!/bin/sh
set -e

#
# This script is run by mygrate before up.sql is executed
#

PLV8_SRC=../../plv8
PATH=../../node_modules/.bin:$PATH

        #--insert-global-vars __filename,__dirname,global \
# Whether to minify
if [ "$MINIFY" = "1" ]; then
    browserify \
        -t coffeeify --extension=".coffee"  \
        -t requireify \
        $PLV8_SRC/index.js ../../plv8/test/index.js | uglifyjs > bundle.js
else
    browserify \
        -t coffeeify --extension=".coffee"  \
        -t requireify \
        $PLV8_SRC/index.js ../../plv8/test/index.js > bundle.js
fi

# Create the single file up.sql required by mygrate
cat << EOF > up.sql
/*
 * DO NOT EDIT. THIS FILE IS AUTOGENERATED BY prehook.
 *
 * Edit up-header.sql, up-footer.sql or up-functions.sql instead.
 */
EOF
cat up-header.sql bundle.js up-footer.sql up-functions.sql >> up.sql
rm bundle.js
