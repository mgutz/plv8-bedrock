#!/bin/sh
set -e

#
# This script is run by mygrate before up.sql is executed
#

MIGRATIONS_DIR=$(pwd)
cd ../../plv8

PATH=../node_modules/.bin:$PATH


# Whether to minify
if [ "$MINIFY" = "1" ]; then
    browserify \
        -t coffeeify --extension=".coffee"  \
        -r "./test" \
        -r "./test/microspec" \
        index.js test/index.js | uglifyjs > /tmp/bundle.js
else
    browserify \
        -t coffeeify --extension=".coffee"  \
        -r "./test" \
        -r "./test/microspec" \
        index.js test/index.js > /tmp/bundle.js
fi

tr -d '\r' < /tmp/bundle.js > /tmp/bundle_clean.js

# Create the single file up.sql required by mygrate
cat << EOF > $MIGRATIONS_DIR/up.sql
/*
 * DO NOT EDIT. THIS FILE IS AUTOGENERATED BY prehook.
 *
 * Edit up-header.sql, up-footer.sql or up-functions.sql instead.
 */
EOF
cat $MIGRATIONS_DIR/up-header.sql /tmp/bundle_clean.js $MIGRATIONS_DIR/up-footer.sql $MIGRATIONS_DIR/up-functions.sql >> $MIGRATIONS_DIR/up.sql

